/// Iran Bill Validator (Improved Dart Version)
/// Returns:
///  - [-1]  → invalid bill number
///  - [-2]  → invalid payment ID
///  - [billNumber, paddedPaymentId, fee, type]
List<dynamic> iranBill(String billNumber, String paymentId) {
  const billLength = 13;
  const minPaymentId = 7;

  const errBill = [-1];
  const errPayment = [-2];

  const weights = [
    2, 3, 4, 5, 6, 7, 2, 3, 4, 5, 6, 7,
    2, 3, 4, 5, 6, 7, 2, 3, 4, 5, 6, 7,
    2, 3
  ];

  // Simple validation
  if (billNumber.length != billLength) return errBill;
  if (paymentId.length < minPaymentId) return errPayment;

  // Normalize payment ID
  final paddedPaymentId = paymentId.padLeft(billLength, '0');

  // Convert to digit lists
  List<int> toDigits(String s) {
    try {
      return s.split('').map(int.parse).toList();
    } catch (_) {
      return []; // invalid strings fall back to empty
    }
  }

  final billDigits = toDigits(billNumber);
  final paymentDigits = toDigits(paddedPaymentId);

  if (billDigits.length != billLength) return errBill;
  if (paymentDigits.length != billLength) return errPayment;

  final type = billDigits[11];

  /// Generic checksum
  int checksum(List<int> digits, int reverseIndex, int start, int length) {
    var sum = 0;
    for (var i = 0; i < length; i++) {
      final idx = reverseIndex - (start + i);
      sum += digits[idx] * weights[i];
    }
    final mod = 11 - (sum % 11);
    return mod > 9 ? 0 : mod;
  }

  final lastIndex = billLength - 1;

  // 1) Bill validation
  if (checksum(billDigits, lastIndex, 1, 12) != billDigits[lastIndex]) {
    return errBill;
  }

  // 2) Payment ID validation
  if (checksum(paymentDigits, lastIndex, 2, 11) != paymentDigits[lastIndex - 1]) {
    return errPayment;
  }

  // 3) Combined checksum
  final combined = billNumber + paddedPaymentId.substring(5, 12);
  final combinedDigits = toDigits(combined);

  if (combinedDigits.length != 20) return errPayment;

  final combinedLast = combinedDigits.length - 1;
  if (checksum(combinedDigits, combinedLast, 0, 20) != paymentDigits[lastIndex]) {
    return errPayment;
  }

  // 4) Fee calculation
  final amount = int.tryParse(paddedPaymentId.substring(0, 8)) ?? 0;
  if (amount == 0) return errPayment;

  final fee = amount * 1000;
  return [billNumber, paddedPaymentId, fee, type];
}

void main() {
  final billNumber = "7721217800141";
  final paymentId  = "5479201";

  final result = iranBill(billNumber, paymentId);

  if (result.length == 1 && result[0] == -1) {
    print("❌ Invalid bill number");
    return;
  }

  if (result.length == 1 && result[0] == -2) {
    print("❌ Invalid payment ID");
    return;
  }

  // If we reach this point, the bill information is valid.
  final validBillNumber   = result[0];
  final paddedPaymentId   = result[1];
  final calculatedFee     = result[2];
  final billType          = result[3];

  print("✅ Bill validated successfully");
  print("Bill Number: $validBillNumber");
  print("Payment ID (normalized): $paddedPaymentId");
  print("Fee Amount: $calculatedFee");
  print("Bill Type: $billType");
}

✅ Bill validated successfully
Bill Number: 7721217800141
Payment ID (normalized): 0005479201
Fee Amount: 5479200000
Bill Type: 0
